<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); text-align: center; padding: 10px; margin: 0; direction: rtl; color: #1e293b; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; text-align: right; border: 1px solid #e2e8f0; }
        h2 { color: #0f172a; margin: 20px 0; font-weight: 800; }
        h3 { color: var(--primary); border-right: 4px solid var(--primary); padding-right: 10px; margin-top: 0; font-size: 18px; }
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #cbd5e1; margin: 8px 0; box-sizing: border-box; font-size: 15px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
        .class-selector { background: #f1f5f9; padding: 15px; border-radius: 12px; margin: 10px 0; border: 1px solid #e2e8f0; }
        .class-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        .check-item { display: flex; align-items: center; background: white; padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; cursor: pointer; justify-content: center; font-size: 14px; font-weight: bold; }
        .check-item input { width: auto; margin-left: 8px; cursor: pointer; }
        .check-item:has(input:checked) { background: #dbeafe; border-color: var(--primary); color: var(--primary); }

        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin: 5px 0; transition: 0.2s; display: block; }
        .btn:active { transform: scale(0.98); }
        .blue { background: var(--primary); } .green { background: var(--success); } .red { background: var(--danger); } .orange { background: var(--warning); }
        
        .teacher-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .teacher-header { display: flex; justify-content: space-between; align-items: center; }
        .teacher-name { font-weight: bold; font-size: 16px; color: #1e293b; }
        .badge { background: #e2e8f0; color: #475569; padding: 4px 10px; border-radius: 8px; font-size: 12px; margin-left: 4px; display: inline-block; font-weight: 600; }
        .admin-badge { background: #fef3c7; color: #92400e; }
        .actions { display: flex; gap: 10px; margin-top: 5px; }
        .actions button { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>
    <h2>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h2>

    <div class="card">
        <h3>ğŸ‘¨â€ğŸ« Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
        <input type="text" id="tName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="text" id="tID" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)">
        <input type="text" id="tPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        
        <div class="class-selector">
            <strong style="font-size: 14px; color: #475569;">Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù†Ø¯Ø©:</strong>
            <p style="font-size: 12px; color: var(--primary); margin: 5px 0;">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</p>
            <div class="class-group">
                <label class="check-item"><input type="checkbox" name="fClass" value="1/1"> 1/1</label>
                <label class="check-item"><input type="checkbox" name="fClass" value="1/2"> 1/2</label>
                <label class="check-item"><input type="checkbox" name="fClass" value="1/3"> 1/3</label>
                <label class="check-item"><input type="checkbox" name="fClass" value="1/4"> 1/4</label>
                <label class="check-item"><input type="checkbox" name="fClass" value="1/5"> 1/5</label>
            </div>
            <p style="font-size: 12px; color: var(--primary); margin: 10px 0 5px 0;">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</p>
            <div class="class-group">
                <label class="check-item"><input type="checkbox" name="fClass" value="2/1"> 2/1</label>
                <label class="check-item"><input type="checkbox" name="fClass" value="2/2"> 2/2</label>
                <label class="check-item"><input type="checkbox" name="fClass" value="2/3"> 2/3</label>
            </div>
        </div>
        
        <select id="tRole">
            <option value="teacher">ØµÙ„Ø§Ø­ÙŠØ©: Ù…Ø¹Ù„Ù… (Ø±ØµØ¯ ÙÙ‚Ø·)</option>
            <option value="admin">ØµÙ„Ø§Ø­ÙŠØ©: Ø£Ø¯Ù…Ù† (ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„)</option>
        </select>
        
        <button class="btn blue" id="mainBtn" onclick="addTeacher()">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</button>
        <button class="btn orange" id="cancelBtn" style="display:none;" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        
        <div id="teachersList" style="margin-top:25px; border-top: 2px solid #f1f5f9; padding-top: 15px;"></div>
    </div>

    <div class="card">
        <h3>ğŸ“¤ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
        <div style="background:#f8fafc; padding:15px; border-radius:15px; border: 2px dashed #cbd5e1;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</label>
            <input type="file" id="file1" accept=".xlsx, .xls">
            <button class="btn green" onclick="upload(1)">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±</button>
            <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</label>
            <input type="file" id="file2" accept=".xlsx, .xls">
            <button class="btn green" onclick="upload(2)">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
        <select id="expGrade">
            <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
            <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
        </select>
        <button class="btn red" onclick="exportData()">ØªØ­Ù…ÙŠÙ„ Ø´ÙŠØª Ø§Ù„Ù€ 70 Ø¯Ø±Ø¬Ø© (Excel)</button>
    </div>

    <script>
        const currentAdmin = sessionStorage.getItem('userEmail');

        async function addTeacher() {
            const id = document.getElementById('tID').value.trim();
            const name = document.getElementById('tName').value.trim();
            const pass = document.getElementById('tPass').value.trim();
            const role = document.getElementById('tRole').value;
            
            const selectedClasses = Array.from(document.querySelectorAll('input[name="fClass"]:checked')).map(cb => cb.value);

            if(!id || !name || !pass) return alert("Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");

            try {
                await db.collection('teachers').doc(id).set({
                    name, pass, role, assignedClasses: selectedClasses, updatedAt: Date.now()
                }, { merge: true });

                alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
                resetForm();
                loadTeachers();
            } catch (e) { alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸"); }
        }

        async function loadTeachers() {
            const listDiv = document.getElementById('teachersList');
            listDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            const snap = await db.collection('teachers').get();
            let html = '<h4 style="margin:0 0 15px 0; color:#64748b;">Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</h4>';
            
            snap.forEach(doc => {
                const t = doc.data();
                const isAdmin = t.role === 'admin';
                const isMe = doc.id === currentAdmin;
                const classesHtml = t.assignedClasses ? t.assignedClasses.map(c => `<span class="badge">${c}</span>`).join('') : '';

                html += `
                <div class="teacher-item">
                    <div class="teacher-header">
                        <span class="teacher-name">${t.name} ${isMe ? '<small>(Ø£Ù†Øª)</small>' : ''}</span>
                        <span class="badge ${isAdmin ? 'admin-badge' : ''}">${isAdmin ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø¹Ù„Ù…'}</span>
                    </div>
                    <div style="text-align:right;">${classesHtml}</div>
                    <div class="actions">
                        <button style="background:#dbeafe; color:#2563eb;" onclick="editTeacher('${doc.id}', '${t.name}', '${t.pass}', '${t.role}', ${JSON.stringify(t.assignedClasses || [])})">ØªØ¹Ø¯ÙŠÙ„</button>
                        ${!isMe ? `<button style="background:#fee2e2; color:#ef4444;" onclick="deleteTeacher('${doc.id}')">Ø­Ø°Ù</button>` : ''}
                    </div>
                </div>`;
            });
            listDiv.innerHTML = html;
        }

        function editTeacher(id, name, pass, role, classes) {
            document.getElementById('tID').value = id;
            document.getElementById('tID').readOnly = true;
            document.getElementById('tName').value = name;
            document.getElementById('tPass').value = pass;
            document.getElementById('tRole').value = role;
            
            // Ø¶Ø¨Ø· Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            document.querySelectorAll('input[name="fClass"]').forEach(cb => {
                cb.checked = classes.includes(cb.value);
            });

            document.getElementById('mainBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function resetForm() {
            document.getElementById('tID').value = "";
            document.getElementById('tID').readOnly = false;
            document.getElementById('tName').value = "";
            document.getElementById('tPass').value = "";
            document.getElementById('tRole').value = "teacher";
            document.querySelectorAll('input[name="fClass"]').forEach(cb => cb.checked = false);
            document.getElementById('mainBtn').innerText = "Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…";
            document.getElementById('cancelBtn').style.display = "none";
        }

        async function deleteTeacher(id) {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await db.collection('teachers').doc(id).delete();
                loadTeachers();
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)
        async function upload(grade) {
            const fileInput = document.getElementById('file'+grade);
            if(!fileInput.files[0]) return alert("Ø§Ø®ØªØ± Ù…Ù„Ù Ø¥ÙƒØ³ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const batch = db.batch();
                rows.forEach(r => {
                    const ref = db.collection('students').doc();
                    batch.set(ref, { name: r.Ø§Ù„Ø§Ø³Ù…, class: String(r.Ø§Ù„ÙØµÙ„), seatNo: Number(r['Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³']), grade: String(grade) });
                });
                await batch.commit(); alert(`ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ Ø±ÙØ¹ ${rows.length} Ø·Ø§Ù„Ø¨`);
                fileInput.value = "";
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        async function exportData() {
            const grade = document.getElementById('expGrade').value;
            const sSnap = await db.collection('students').where('grade','==',grade).get();
            const gSnap = await db.collection('grades').get();
            const gMap = {};
            gSnap.forEach(d => { const g = d.data(); gMap[`${g.sid}_${g.type}`] = g.score; });
            const report = sSnap.docs.map(doc => {
                const s = doc.data(); const sid = doc.id;
                const t=gMap[sid+'_t']||0, v=gMap[sid+'_v']||0, sc=gMap[sid+'_s']||0, ex=(gMap[sid+'_ex1']||0)+(gMap[sid+'_ex2']||0);
                return { "Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³": s.seatNo, "Ø§Ù„Ø§Ø³Ù…": s.name, "Ø§Ù„ÙØµÙ„": s.class, "ØªÙ‚ÙŠÙŠÙ…(20)": t, "ÙˆØ§Ø¬Ø¨(10)": v, "Ø³Ù„ÙˆÙƒ(10)": sc, "Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª(30)": ex, "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹(70)": t+v+sc+ex };
            }).sort((a,b) => a['Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³'] - b['Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³']);
            const ws = XLSX.utils.json_to_sheet(report);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªØ§Ø¦Ø¬");
            XLSX.writeFile(wb, `Ù†ØªØ§Ø¦Ø¬_Ø§Ù„ØµÙ_${grade}.xlsx`);
        }

        window.onload = loadTeachers;
    </script>
</body>
</html>
